# Flujo de calibraciones en el portal de clientes (`tenant`)

La siguiente tabla resume el flujo operativo certificado (recepción → asignación → ejecución → revisión → emisión → cierre) para las órdenes de trabajo de calibración dentro del portal de clientes. Cada fila indica la interacción principal, los endpoints reales del portal de servicio que respaldan la operación y los artefactos donde se gestiona la trazabilidad.

| Etapa | Descripción dentro del portal tenant | Endpoints / Artefactos relacionados |
| --- | --- | --- |
| Recepción de solicitud | El cliente revisa las calibraciones recibidas y valida que los instrumentos están dados de alta. | `public/backend/calibraciones/list_calibrations.php` lista las órdenes visibles para la empresa activa mediante `obtenerEmpresaId()` en el backend. |
| Gestión de OT | El responsable prepara la orden para ser atendida actualizando fechas objetivo, observaciones y estado operativo. Toda la interacción proviene del formulario en `public/apps/service/calibraciones/list_calibrations.html`, que consume los endpoints `public/backend/calibraciones/list_calibrations.php`, `public/backend/calibraciones/update_work_order.php` y `public/backend/calibraciones/list_technicians.php`. El endpoint histórico `/servicio/ot` ya no se utiliza y debe reemplazarse por `/backend/calibraciones/update_work_order.php` en cualquier referencia o automatización. | `/backend/calibraciones/update_work_order.php` (expuesto desde la raíz pública) delega en el módulo tenant correspondiente para persistir los cambios de la orden de trabajo. |
| Asignación de técnicos/recursos | Desde la misma vista `public/apps/service/calibraciones/list_calibrations.html` el supervisor asigna técnicos, define ventanas de ejecución y deja notas internas. El endpoint `public/backend/calibraciones/update_work_order.php` incluye a `app/Modules/Tenant/Calibraciones/update_work_order.php`, donde se validan los permisos del tenant y se guardan técnicos, fechas y observaciones asociados a la orden. El listado de técnicos disponibles proviene de `public/backend/calibraciones/list_technicians.php`. | `app/Modules/Tenant/Calibraciones/update_work_order.php` controla la lógica de asignación usando los helpers de `app/Core/` y respeta la segmentación por empresa para cumplir ISO/IEC 17025. |
| Ejecución de calibración | Técnicos asignados registran avances, resultados parciales y adjuntan evidencia según los requisitos del laboratorio. | `public/backend/calibraciones/update_logistics.php` permite documentar el envío, tránsito y recepción de equipos externos mientras que `public/backend/calibraciones/calibrations.php` guarda el progreso interno. |
| Revisión y validación | Supervisores validan resultados, aseguran que se adjuntó la evidencia requerida y aplican el checklist ISO 17025 antes de cerrar la ejecución. | `public/backend/calibraciones/approve_calibration.php` y `public/backend/calibraciones/reject_calibration.php` controlan la liberación o rechazo, dejando constancia en auditoría. |
| Emisión de informe | Se genera el certificado de calibración y se comparte con el cliente siguiendo los formatos NOM-059. | `public/backend/calibraciones/share_certificate.php` publica el certificado y notifica a los contactos definidos. |
| Cierre de orden | Tras entregar el informe, la orden cambia a estado “Cerrada” y se archiva el historial para auditorías futuras. | El propio `public/backend/calibraciones/update_work_order.php` actualiza el estado a “Cerrada” y conserva el historial en la tabla `ordenes_calibracion`, accesible desde los reportes del módulo tenant. |

> Nota: todos los endpoints listados deben ejecutarse con una sesión válida en el portal tenant; internamente se verifica el contexto `$_SESSION['app_context']` y se utiliza `obtenerEmpresaId()` para aislar los datos por empresa.
