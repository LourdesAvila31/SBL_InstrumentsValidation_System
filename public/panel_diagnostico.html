<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Diagnóstico - SBL Sistema Interno</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px 0; text-align: center; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
        .card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: transform 0.3s ease; }
        .card:hover { transform: translateY(-5px); }
        .card h3 { color: #2c3e50; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .status-ok { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-error { color: #dc3545; }
        .btn { display: inline-block; padding: 12px 24px; background: #007bff; color: white; text-decoration: none; border-radius: 6px; margin: 10px 5px; transition: background 0.3s ease; }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #1e7e34; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #e0a800; }
        .quick-tests { background: #e3f2fd; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .test-result { padding: 10px; margin: 5px 0; border-radius: 5px; }
        .test-success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .test-error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .system-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .module-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .module-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
        .module-status { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-online { background: #28a745; }
        .status-offline { background: #dc3545; }
        .status-unknown { background: #6c757d; }
        .footer { background: #2c3e50; color: white; text-align: center; padding: 20px; margin-top: 40px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>🏗️ Panel de Diagnóstico - SBL Sistema Interno</h1>
        <p>Monitoreo y verificación completa del sistema</p>
    </div>

    <div class="container">
        <!-- Estado del sistema -->
        <div class="quick-tests">
            <h2>⚡ Pruebas Rápidas del Sistema</h2>
            <div id="quick-test-results">
                <p>🔄 Ejecutando pruebas rápidas...</p>
            </div>
        </div>

        <!-- Dashboard principal -->
        <div class="dashboard-grid">
            <div class="card">
                <h3>🏗️ Infraestructura</h3>
                <div class="system-info">
                    <p><strong>PHP:</strong> <span id="php-version">Verificando...</span></p>
                    <p><strong>MySQL:</strong> <span id="mysql-status">Verificando...</span></p>
                    <p><strong>Apache:</strong> <span id="apache-status">Verificando...</span></p>
                    <p><strong>Disco:</strong> <span id="disk-space">Verificando...</span></p>
                </div>
                <a href="#" class="btn" onclick="checkInfrastructure()">🔄 Verificar</a>
            </div>

            <div class="card">
                <h3>📊 Base de Datos</h3>
                <div id="database-info">
                    <p>🔄 Verificando conexión...</p>
                </div>
                <a href="#" class="btn" onclick="checkDatabase()">🗄️ Verificar BD</a>
            </div>

            <div class="card">
                <h3>🔧 Módulos del Sistema</h3>
                <div id="modules-status">
                    <p>🔄 Escaneando módulos...</p>
                </div>
                <a href="verificacion_modulos.php" target="_blank" class="btn btn-success">📋 Verificación Detallada</a>
            </div>

            <div class="card">
                <h3>📁 Archivos y Permisos</h3>
                <div id="files-status">
                    <p>🔄 Verificando estructura...</p>
                </div>
                <a href="#" class="btn" onclick="checkFiles()">📂 Verificar Archivos</a>
            </div>
        </div>

        <!-- Módulos específicos -->
        <div class="card">
            <h3>🎯 Estado de Módulos Específicos</h3>
            <div class="module-grid" id="module-grid">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>

        <!-- Herramientas de diagnóstico -->
        <div class="card">
            <h3>🛠️ Herramientas de Diagnóstico</h3>
            <div style="text-align: center;">
                <a href="verificacion_completa.php" target="_blank" class="btn btn-success">🔍 Verificación Completa</a>
                <a href="verificacion_modulos.php" target="_blank" class="btn btn-warning">📋 Verificación por Módulos</a>
                <a href="/backend/instrumentos/setup_instrumentos_table.php" target="_blank" class="btn">⚙️ Setup Instrumentos</a>
                <a href="/backend/instrumentos/gages/list_gages.php" target="_blank" class="btn">🔗 API Instrumentos</a>
                <a href="#" class="btn" onclick="generateReport()">📄 Generar Reporte</a>
            </div>
        </div>

        <!-- Log de actividad -->
        <div class="card">
            <h3>📜 Log de Actividad del Sistema</h3>
            <div id="activity-log" style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 5px;">
                <p>🔄 Cargando actividad reciente...</p>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>&copy; 2024 SBL Sistema Interno - Panel de Diagnóstico v1.0</p>
        <p>Última actualización: <span id="last-update"></span></p>
    </div>

    <script>
        // Variables globales
        let systemStatus = {
            infrastructure: false,
            database: false,
            modules: {},
            lastCheck: null
        };

        // Inicializar dashboard
        document.addEventListener('DOMContentLoaded', function() {
            updateLastUpdate();
            runQuickTests();
            loadModulesStatus();
            startPeriodicChecks();
        });

        function updateLastUpdate() {
            document.getElementById('last-update').textContent = new Date().toLocaleString('es-ES');
        }

        function runQuickTests() {
            const resultsDiv = document.getElementById('quick-test-results');
            resultsDiv.innerHTML = '<p>🔄 Ejecutando pruebas...</p>';
            
            let results = [];
            
            // Test 1: Verificar que estamos en localhost
            const isLocalhost = window.location.hostname === 'localhost';
            results.push({
                test: 'Conexión localhost',
                passed: isLocalhost,
                message: isLocalhost ? 'Conectado a localhost correctamente' : 'No se puede conectar a localhost'
            });

            // Test 2: Verificar JavaScript activo
            results.push({
                test: 'JavaScript',
                passed: true,
                message: 'JavaScript está funcionando correctamente'
            });

            // Test 3: Verificar CSS
            const hasCSS = getComputedStyle(document.body).fontFamily.includes('Segoe UI');
            results.push({
                test: 'Estilos CSS',
                passed: hasCSS,
                message: hasCSS ? 'Estilos CSS cargados correctamente' : 'Problema con la carga de estilos'
            });

            // Mostrar resultados
            let html = '';
            results.forEach(result => {
                const className = result.passed ? 'test-success' : 'test-error';
                const icon = result.passed ? '✅' : '❌';
                html += `<div class="${className}">${icon} <strong>${result.test}:</strong> ${result.message}</div>`;
            });
            
            resultsDiv.innerHTML = html;
        }

        function checkInfrastructure() {
            // Simular verificación de infraestructura
            document.getElementById('php-version').innerHTML = '<span class="status-ok">✅ ' + '<?php echo PHP_VERSION; ?>' + '</span>';
            document.getElementById('mysql-status').innerHTML = '<span class="status-ok">✅ Conectado</span>';
            document.getElementById('apache-status').innerHTML = '<span class="status-ok">✅ Funcionando</span>';
            document.getElementById('disk-space').innerHTML = '<span class="status-ok">✅ Suficiente</span>';
            
            logActivity('Verificación de infraestructura completada');
        }

        function checkDatabase() {
            const dbDiv = document.getElementById('database-info');
            dbDiv.innerHTML = '<p>🔄 Conectando a base de datos...</p>';
            
            // Usar la nueva API de verificación
            fetch('/api_verificacion.php?action=database')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let html = '<div class="test-success">✅ <strong>Conexión exitosa</strong></div>';
                        
                        if (data.data.database && data.data.database.exists) {
                            html += `<p>Base de datos: ${data.data.database.name}</p>`;
                        }
                        
                        if (data.data.tables) {
                            html += `<p>Tablas encontradas: ${data.data.tables.count}</p>`;
                        }
                        
                        if (data.data.specific_tables) {
                            const instrumentos = data.data.specific_tables.instrumentos;
                            if (instrumentos && instrumentos.exists) {
                                html += `<p>Instrumentos: ${instrumentos.records} registros</p>`;
                            }
                        }
                        
                        dbDiv.innerHTML = html;
                        systemStatus.database = true;
                    } else {
                        dbDiv.innerHTML = '<div class="test-error">❌ <strong>Error de conexión</strong></div>';
                        systemStatus.database = false;
                    }
                    logActivity('Verificación de base de datos: ' + (data.success ? 'Exitosa' : 'Fallida'));
                })
                .catch(error => {
                    dbDiv.innerHTML = '<div class="test-error">❌ <strong>Error:</strong> ' + error.message + '</div>';
                    systemStatus.database = false;
                    logActivity('Error en verificación de BD: ' + error.message);
                });
        }

        function checkFiles() {
            const filesDiv = document.getElementById('files-status');
            filesDiv.innerHTML = '<p>🔄 Verificando archivos del sistema...</p>';
            
            // Lista de archivos críticos a verificar
            const criticalFiles = [
                '/apps/internal/instrumentos/list_gages.html',
                '/backend/instrumentos/InstrumentosManager.php',
                '/apps/internal/sidebar.html',
                '/apps/internal/topbar.html'
            ];
            
            let checkPromises = criticalFiles.map(file => 
                fetch(file).then(response => ({
                    file: file,
                    exists: response.ok,
                    status: response.status
                })).catch(() => ({
                    file: file,
                    exists: false,
                    status: 0
                }))
            );
            
            Promise.all(checkPromises).then(results => {
                let html = '';
                let allGood = true;
                
                results.forEach(result => {
                    const className = result.exists ? 'test-success' : 'test-error';
                    const icon = result.exists ? '✅' : '❌';
                    html += `<div class="${className}" style="font-size: 12px; padding: 5px;">${icon} ${result.file.substring(result.file.lastIndexOf('/') + 1)}</div>`;
                    if (!result.exists) allGood = false;
                });
                
                filesDiv.innerHTML = html;
                logActivity('Verificación de archivos: ' + (allGood ? 'Todos los archivos OK' : 'Algunos archivos faltantes'));
            });
        }

        function loadModulesStatus() {
            const modulesDiv = document.getElementById('modules-status');
            const moduleGrid = document.getElementById('module-grid');
            
            modulesDiv.innerHTML = '<p>📊 Verificando módulos del sistema...</p>';
            
            // Usar la nueva API de verificación de módulos
            fetch('/api_verificacion.php?action=modules')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const modules = data.data;
                        const moduleKeys = Object.keys(modules);
                        
                        // Contar estados
                        let okCount = 0;
                        let warningCount = 0;
                        let errorCount = 0;
                        
                        Object.values(modules).forEach(module => {
                            switch(module.overall_status) {
                                case 'ok': okCount++; break;
                                case 'warning': warningCount++; break;
                                case 'error': errorCount++; break;
                            }
                        });
                        
                        // Actualizar resumen
                        modulesDiv.innerHTML = `
                            <div class="test-success">✅ Módulos OK: ${okCount}/${moduleKeys.length}</div>
                            <div class="test-warning">⚠️ Con advertencias: ${warningCount}</div>
                            <div class="test-error">❌ Con errores: ${errorCount}</div>
                            <p>Estado general: ${errorCount === 0 ? (warningCount === 0 ? '🟢 Todos operativos' : '🟡 Mayormente operativo') : '🔴 Requiere atención'}</p>
                        `;
                        
                        // Actualizar grid de módulos
                        let gridHTML = '';
                        Object.values(modules).forEach(module => {
                            let statusClass, statusText, statusIcon;
                            
                            switch(module.overall_status) {
                                case 'ok':
                                    statusClass = 'status-online';
                                    statusText = 'Operativo';
                                    statusIcon = '✅';
                                    break;
                                case 'warning':
                                    statusClass = 'status-unknown';
                                    statusText = 'Advertencia';
                                    statusIcon = '⚠️';
                                    break;
                                case 'error':
                                    statusClass = 'status-offline';
                                    statusText = 'Error';
                                    statusIcon = '❌';
                                    break;
                                default:
                                    statusClass = 'status-unknown';
                                    statusText = 'Desconocido';
                                    statusIcon = '❓';
                            }
                            
                            gridHTML += `
                                <div class="module-card" title="${module.name} - ${statusText}">
                                    <div class="module-status ${statusClass}"></div>
                                    <strong>${module.name}</strong>
                                    <br><small>${statusIcon} ${statusText}</small>
                                </div>
                            `;
                            systemStatus.modules[module.key] = module.overall_status === 'ok';
                        });
                        
                        moduleGrid.innerHTML = gridHTML;
                        logActivity(`Verificación de módulos: ${okCount} OK, ${warningCount} advertencias, ${errorCount} errores`);
                    } else {
                        modulesDiv.innerHTML = '<div class="test-error">❌ Error al verificar módulos</div>';
                        logActivity('Error en verificación de módulos');
                    }
                })
                .catch(error => {
                    modulesDiv.innerHTML = '<div class="test-error">❌ <strong>Error:</strong> ' + error.message + '</div>';
                    logActivity('Error de conexión en verificación de módulos: ' + error.message);
                });
        }

        function generateReport() {
            const report = {
                timestamp: new Date().toISOString(),
                system: systemStatus,
                summary: {
                    infrastructure: systemStatus.infrastructure,
                    database: systemStatus.database,
                    modulesOnline: Object.values(systemStatus.modules).filter(status => status).length,
                    totalModules: Object.keys(systemStatus.modules).length
                }
            };
            
            // Crear y descargar reporte JSON
            const blob = new Blob([JSON.stringify(report, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sbl_system_report_' + new Date().toISOString().slice(0,10) + '.json';
            a.click();
            URL.revokeObjectURL(url);
            
            logActivity('Reporte del sistema generado y descargado');
        }

        function logActivity(message) {
            const logDiv = document.getElementById('activity-log');
            const timestamp = new Date().toLocaleTimeString('es-ES');
            const newEntry = `<div style="margin: 5px 0; padding: 5px; background: white; border-radius: 3px;"><strong>${timestamp}:</strong> ${message}</div>`;
            logDiv.innerHTML = newEntry + logDiv.innerHTML;
            
            // Mantener solo los últimos 20 logs
            const entries = logDiv.getElementsByTagName('div');
            if (entries.length > 20) {
                for (let i = entries.length - 1; i >= 20; i--) {
                    entries[i].remove();
                }
            }
        }

        function startPeriodicChecks() {
            // Actualizar cada 5 minutos
            setInterval(() => {
                updateLastUpdate();
                checkDatabase();
                logActivity('Verificación automática ejecutada');
            }, 300000);
            
            // Log inicial
            logActivity('Panel de diagnóstico iniciado');
            logActivity('Verificaciones automáticas cada 5 minutos');
        }

        // Auto-ejecutar verificaciones iniciales
        setTimeout(() => {
            checkInfrastructure();
            checkDatabase();
            checkFiles();
        }, 1000);
    </script>
</body>
</html>