<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <script>
        (function() {
            var marker = '/public/';
            var path = window.location.pathname || '';
            var index = path.indexOf(marker);
            var base = index !== -1 ? path.slice(0, index + marker.length) : '/';
            if (!base.endsWith('/')) {
                base += '/';
            }
            window.BASE_URL = base === '/' ? '' : base.replace(/\/$/, '');
            document.write('<base href="' + base + '">');
        })();
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Tickets - Sistema GAMP 5 & GxP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/styles/master-theme.css">
    <style>
        .tickets-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }
        
        .filter-bar {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .ticket-card {
            background: white;
            border-radius: 10px;
            border-left: 4px solid transparent;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .ticket-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .ticket-card.priority-CRITICO { border-left-color: #dc3545; }
        .ticket-card.priority-ALTO { border-left-color: #fd7e14; }
        .ticket-card.priority-MEDIO { border-left-color: #ffc107; }
        .ticket-card.priority-BAJO { border-left-color: #20c997; }
        .ticket-card.priority-MINIMO { border-left-color: #6c757d; }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .status-ABIERTO { background: #d1ecf1; color: #0c5460; }
        .status-EN_PROGRESO { background: #fff3cd; color: #856404; }
        .status-EN_REVISION { background: #e2e3f0; color: #383d41; }
        .status-RESUELTO { background: #d4edda; color: #155724; }
        .status-CERRADO { background: #f8f9fa; color: #6c757d; }
        .status-ESCALADO { background: #f8d7da; color: #721c24; }
        
        .priority-badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
        }
        
        .priority-CRITICO { background: #dc3545; }
        .priority-ALTO { background: #fd7e14; }
        .priority-MEDIO { background: #ffc107; color: #000; }
        .priority-BAJO { background: #20c997; }
        .priority-MINIMO { background: #6c757d; }
        
        .create-ticket-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            background: var(--sbl-primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(13, 87, 90, 0.4);
            transition: all 0.3s ease;
        }
        
        .create-ticket-btn:hover {
            transform: scale(1.1);
            background: var(--sbl-secondary);
            color: white;
        }
        
        .ticket-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--sbl-primary) 0%, var(--sbl-secondary) 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        @media (max-width: 768px) {
            .tickets-section {
                padding: 15px;
            }
            
            .filter-bar {
                padding: 15px;
            }
            
            .create-ticket-btn {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
            
            .ticket-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-number {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Botón toggle móvil -->
    <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="sidebar">
        <div class="sidebar-logo">
            <img src="assets/images/sbl-logo.png" alt="Logo SBL Pharma" class="logo"/>
        </div>
        <nav class="sidebar-nav">
            <a class="nav-link" href="index.html">
                <i class="fa fa-tachometer-alt"></i>
                <span>DASHBOARD</span>
            </a>
            <a class="nav-link active" href="tickets.html">
                <i class="fa fa-ticket-alt"></i>
                <span>TICKETS</span>
            </a>
            <a class="nav-link" href="matrix.html">
                <i class="fa fa-table"></i>
                <span>MATRIZ RIESGO</span>
            </a>
            <a class="nav-link" href="reports.html">
                <i class="fa fa-chart-bar"></i>
                <span>REPORTES</span>
            </a>
            <a class="nav-link" href="settings.html">
                <i class="fa fa-cog"></i>
                <span>CONFIGURACIÓN</span>
            </a>
        </nav>
    </aside>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="main-content">
        <!-- Topbar -->
        <div class="topbar">
            <div class="topbar-left">
                <span class="topbar-title">Gestión de Tickets - GAMP 5 & GxP</span>
            </div>
            <div class="topbar-icons">
                <i class="fas fa-bell" title="Notificaciones"></i>
                <i class="fas fa-user-circle" title="Perfil" onclick="showProfile()"></i>
                <i class="fas fa-sign-out-alt" title="Cerrar Sesión" onclick="logout()"></i>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div class="dashboard-section">
            <div class="dashboard-bar">
                <i class="fas fa-ticket-alt me-2"></i>
                GESTIÓN DE TICKETS
            </div>

            <!-- Estadísticas -->
            <div class="ticket-stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalTickets">0</div>
                    <div class="stat-label">Total Tickets</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="openTickets">0</div>
                    <div class="stat-label">Abiertos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="criticalTickets">0</div>
                    <div class="stat-label">Críticos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="myTickets">0</div>
                    <div class="stat-label">Mis Tickets</div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="filter-bar">
                <div class="row align-items-end">
                    <div class="col-md-2">
                        <label class="form-label">Estado</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">Todos</option>
                            <option value="ABIERTO">Abierto</option>
                            <option value="EN_PROGRESO">En Progreso</option>
                            <option value="EN_REVISION">En Revisión</option>
                            <option value="RESUELTO">Resuelto</option>
                            <option value="CERRADO">Cerrado</option>
                            <option value="ESCALADO">Escalado</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Prioridad</label>
                        <select class="form-select" id="priorityFilter">
                            <option value="">Todas</option>
                            <option value="CRITICO">Crítico</option>
                            <option value="ALTO">Alto</option>
                            <option value="MEDIO">Medio</option>
                            <option value="BAJO">Bajo</option>
                            <option value="MINIMO">Mínimo</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Categoría</label>
                        <select class="form-select" id="categoryFilter">
                            <option value="">Todas</option>
                            <option value="SISTEMA">Sistema</option>
                            <option value="HARDWARE">Hardware</option>
                            <option value="SOFTWARE">Software</option>
                            <option value="PROCESO">Proceso</option>
                            <option value="DOCUMENTACION">Documentación</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Buscar</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="Buscar por título o descripción...">
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary me-2" onclick="applyFilters()">
                            <i class="fas fa-search me-1"></i>Filtrar
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="fas fa-times me-1"></i>Limpiar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Lista de Tickets -->
            <div class="tickets-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5><i class="fas fa-list me-2"></i>Lista de Tickets</h5>
                    <div class="d-flex gap-2">
                        <select class="form-select" id="sortBy" style="width: auto;">
                            <option value="created_at">Fecha de Creación</option>
                            <option value="priority">Prioridad</option>
                            <option value="status">Estado</option>
                            <option value="title">Título</option>
                        </select>
                        <button class="btn btn-outline-secondary btn-sm" onclick="toggleSortOrder()">
                            <i class="fas fa-sort" id="sortIcon"></i>
                        </button>
                    </div>
                </div>
                
                <div id="ticketsList">
                    <!-- Los tickets se cargarán aquí dinámicamente -->
                </div>
                
                <!-- Paginación -->
                <nav>
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- La paginación se generará dinámicamente -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Botón flotante para crear ticket -->
    <button class="create-ticket-btn" onclick="showCreateTicketModal()" title="Crear Nuevo Ticket">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Modal para Crear/Editar Ticket -->
    <div class="modal fade" id="ticketModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ticketModalTitle">Crear Nuevo Ticket</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="ticketForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Título <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="ticketTitle" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Categoría <span class="text-danger">*</span></label>
                                    <select class="form-select" id="ticketCategory" required>
                                        <option value="">Seleccionar categoría</option>
                                        <option value="SISTEMA">Sistema</option>
                                        <option value="HARDWARE">Hardware</option>
                                        <option value="SOFTWARE">Software</option>
                                        <option value="PROCESO">Proceso</option>
                                        <option value="DOCUMENTACION">Documentación</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Prioridad <span class="text-danger">*</span></label>
                                    <select class="form-select" id="ticketPriority" required>
                                        <option value="">Seleccionar prioridad</option>
                                        <option value="CRITICO">Crítico</option>
                                        <option value="ALTO">Alto</option>
                                        <option value="MEDIO">Medio</option>
                                        <option value="BAJO">Bajo</option>
                                        <option value="MINIMO">Mínimo</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Probabilidad</label>
                                    <select class="form-select" id="ticketProbability">
                                        <option value="">Seleccionar</option>
                                        <option value="5">Muy Alta (5)</option>
                                        <option value="4">Alta (4)</option>
                                        <option value="3">Media (3)</option>
                                        <option value="2">Baja (2)</option>
                                        <option value="1">Muy Baja (1)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Impacto</label>
                                    <select class="form-select" id="ticketImpact">
                                        <option value="">Seleccionar</option>
                                        <option value="5">Catastrófico (5)</option>
                                        <option value="4">Mayor (4)</option>
                                        <option value="3">Moderado (3)</option>
                                        <option value="2">Menor (2)</option>
                                        <option value="1">Negligible (1)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Descripción <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="ticketDescription" rows="4" required placeholder="Describe detalladamente el problema o solicitud..."></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Asignar a</label>
                                    <select class="form-select" id="ticketAssignee">
                                        <option value="">Sin asignar</option>
                                        <option value="1">Ana García - Administradora</option>
                                        <option value="2">Carlos Ruiz - Técnico Senior</option>
                                        <option value="3">María López - Analista QA</option>
                                        <option value="4">José Martín - Desarrollador</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Fecha Límite</label>
                                    <input type="datetime-local" class="form-control" id="ticketDueDate">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Archivos Adjuntos</label>
                            <input type="file" class="form-control" id="ticketAttachments" multiple>
                            <small class="form-text text-muted">Puedes adjuntar múltiples archivos (máx. 10MB c/u)</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveTicket()">
                        <i class="fas fa-save me-1"></i>Guardar Ticket
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Ver Detalles del Ticket -->
    <div class="modal fade" id="ticketDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ticketDetailsTitle">Detalles del Ticket</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="ticketDetailsBody">
                    <!-- Contenido dinámico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-warning" onclick="editCurrentTicket()">
                        <i class="fas fa-edit me-1"></i>Editar
                    </button>
                    <button type="button" class="btn btn-success" onclick="addComment()">
                        <i class="fas fa-comment me-1"></i>Agregar Comentario
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales
        let currentPage = 1;
        let itemsPerPage = 10;
        let currentFilters = {};
        let currentSort = { field: 'created_at', ascending: false };
        let allTickets = [];
        let currentTicketId = null;
        
        // Datos simulados de tickets
        const sampleTickets = [
            {
                id: 1,
                number: 'TK-0001',
                title: 'Error en validación de datos críticos',
                description: 'El sistema no está validando correctamente los datos de entrada en el módulo de fabricación.',
                status: 'ABIERTO',
                priority: 'CRITICO',
                category: 'SISTEMA',
                created_at: '2024-01-15T10:30:00',
                created_by: 'Ana García',
                assigned_to: 'Carlos Ruiz',
                due_date: '2024-01-15T14:30:00',
                probability: 4,
                impact: 5
            },
            {
                id: 2,
                number: 'TK-0002',
                title: 'Actualización de procedimientos de calibración',
                description: 'Revisar y actualizar los procedimientos de calibración según nueva normativa.',
                status: 'EN_PROGRESO',
                priority: 'MEDIO',
                category: 'DOCUMENTACION',
                created_at: '2024-01-14T14:20:00',
                created_by: 'María López',
                assigned_to: 'José Martín',
                due_date: '2024-01-20T17:00:00',
                probability: 2,
                impact: 3
            },
            {
                id: 3,
                number: 'TK-0003',
                title: 'Fallo intermitente en sensor de temperatura',
                description: 'Sensor de temperatura del reactor principal presenta lecturas inconsistentes.',
                status: 'ESCALADO',
                priority: 'ALTO',
                category: 'HARDWARE',
                created_at: '2024-01-13T08:45:00',
                created_by: 'Carlos Ruiz',
                assigned_to: 'Ana García',
                due_date: '2024-01-16T12:00:00',
                probability: 3,
                impact: 4
            }
        ];
        
        // Inicializar cuando carga la página
        document.addEventListener('DOMContentLoaded', function() {
            initResponsiveSidebar();
            allTickets = [...sampleTickets];
            loadTickets();
            updateStats();
        });
        
        // Funcionalidad responsiva del sidebar
        function initResponsiveSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const mainContent = document.querySelector('.main-content');
            
            function toggleSidebar() {
                sidebar.classList.toggle('show');
                sidebar.classList.toggle('hidden');
                
                if (window.innerWidth <= 768) {
                    mainContent.classList.toggle('expanded');
                }
            }
            
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', toggleSidebar);
            }
            
            document.addEventListener('click', function(event) {
                if (window.innerWidth <= 768) {
                    if (!sidebar.contains(event.target) && !sidebarToggle.contains(event.target)) {
                        sidebar.classList.remove('show');
                        sidebar.classList.add('hidden');
                        mainContent.classList.add('expanded');
                    }
                }
            });
            
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    sidebar.classList.remove('show', 'hidden');
                    mainContent.classList.remove('expanded');
                } else {
                    sidebar.classList.add('hidden');
                    mainContent.classList.add('expanded');
                }
            });
            
            if (window.innerWidth <= 768) {
                sidebar.classList.add('hidden');
                mainContent.classList.add('expanded');
            }
        }
        
        // Cargar y mostrar tickets
        function loadTickets() {
            let filteredTickets = filterTickets([...allTickets]);
            filteredTickets = sortTickets(filteredTickets);
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageTickets = filteredTickets.slice(startIndex, endIndex);
            
            displayTickets(pageTickets);
            generatePagination(filteredTickets.length);
        }
        
        // Filtrar tickets
        function filterTickets(tickets) {
            return tickets.filter(ticket => {
                const matchesStatus = !currentFilters.status || ticket.status === currentFilters.status;
                const matchesPriority = !currentFilters.priority || ticket.priority === currentFilters.priority;
                const matchesCategory = !currentFilters.category || ticket.category === currentFilters.category;
                const matchesSearch = !currentFilters.search || 
                    ticket.title.toLowerCase().includes(currentFilters.search.toLowerCase()) ||
                    ticket.description.toLowerCase().includes(currentFilters.search.toLowerCase());
                
                return matchesStatus && matchesPriority && matchesCategory && matchesSearch;
            });
        }
        
        // Ordenar tickets
        function sortTickets(tickets) {
            return tickets.sort((a, b) => {
                let aValue = a[currentSort.field];
                let bValue = b[currentSort.field];
                
                if (currentSort.field === 'created_at') {
                    aValue = new Date(aValue);
                    bValue = new Date(bValue);
                }
                
                if (aValue < bValue) return currentSort.ascending ? -1 : 1;
                if (aValue > bValue) return currentSort.ascending ? 1 : -1;
                return 0;
            });
        }
        
        // Mostrar tickets en la interfaz
        function displayTickets(tickets) {
            const container = document.getElementById('ticketsList');
            
            if (tickets.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No se encontraron tickets</h5>
                        <p class="text-muted">Intenta ajustar los filtros o crear un nuevo ticket</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = tickets.map(ticket => `
                <div class="ticket-card priority-${ticket.priority}" onclick="showTicketDetails(${ticket.id})">
                    <div class="card-body p-3">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="d-flex align-items-center mb-2">
                                    <strong class="me-3">${ticket.number}</strong>
                                    <span class="status-badge status-${ticket.status}">${ticket.status.replace('_', ' ')}</span>
                                    <span class="priority-badge priority-${ticket.priority} ms-2">${ticket.priority}</span>
                                </div>
                                <h6 class="card-title mb-2">${ticket.title}</h6>
                                <p class="card-text text-muted mb-2">${ticket.description.substring(0, 120)}${ticket.description.length > 120 ? '...' : ''}</p>
                                <small class="text-muted">
                                    <i class="fas fa-user me-1"></i>${ticket.created_by} • 
                                    <i class="fas fa-calendar me-1"></i>${new Date(ticket.created_at).toLocaleDateString()} •
                                    <i class="fas fa-tag me-1"></i>${ticket.category}
                                </small>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="mb-2">
                                    ${ticket.assigned_to ? `<small class="text-muted">Asignado a: <strong>${ticket.assigned_to}</strong></small>` : '<small class="text-muted">Sin asignar</small>'}
                                </div>
                                ${ticket.due_date ? `
                                    <div class="mb-2">
                                        <small class="text-muted">
                                            Vence: ${new Date(ticket.due_date).toLocaleDateString()}
                                            ${new Date(ticket.due_date) < new Date() ? '<span class="text-danger">(Vencido)</span>' : ''}
                                        </small>
                                    </div>
                                ` : ''}
                                <div class="d-flex justify-content-end gap-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); editTicket(${ticket.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); addComment(${ticket.id})">
                                        <i class="fas fa-comment"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Generar paginación
        function generatePagination(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const container = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // Botón anterior
            html += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Anterior</a>
                </li>
            `;
            
            // Números de página
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                        </li>
                    `;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }
            
            // Botón siguiente
            html += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Siguiente</a>
                </li>
            `;
            
            container.innerHTML = html;
        }
        
        // Cambiar página
        function changePage(page) {
            const totalPages = Math.ceil(filterTickets([...allTickets]).length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                loadTickets();
            }
        }
        
        // Aplicar filtros
        function applyFilters() {
            currentFilters = {
                status: document.getElementById('statusFilter').value,
                priority: document.getElementById('priorityFilter').value,
                category: document.getElementById('categoryFilter').value,
                search: document.getElementById('searchInput').value
            };
            
            // Remover filtros vacíos
            Object.keys(currentFilters).forEach(key => {
                if (!currentFilters[key]) delete currentFilters[key];
            });
            
            currentPage = 1;
            loadTickets();
        }
        
        // Limpiar filtros
        function clearFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('priorityFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('searchInput').value = '';
            currentFilters = {};
            currentPage = 1;
            loadTickets();
        }
        
        // Cambiar orden
        function toggleSortOrder() {
            currentSort.ascending = !currentSort.ascending;
            document.getElementById('sortIcon').className = currentSort.ascending ? 'fas fa-sort-up' : 'fas fa-sort-down';
            loadTickets();
        }
        
        // Actualizar estadísticas
        function updateStats() {
            const total = allTickets.length;
            const open = allTickets.filter(t => ['ABIERTO', 'EN_PROGRESO', 'EN_REVISION'].includes(t.status)).length;
            const critical = allTickets.filter(t => t.priority === 'CRITICO').length;
            const my = allTickets.filter(t => t.assigned_to === 'Usuario Actual').length; // Placeholder
            
            document.getElementById('totalTickets').textContent = total;
            document.getElementById('openTickets').textContent = open;
            document.getElementById('criticalTickets').textContent = critical;
            document.getElementById('myTickets').textContent = my;
        }
        
        // Mostrar modal para crear ticket
        function showCreateTicketModal() {
            document.getElementById('ticketModalTitle').textContent = 'Crear Nuevo Ticket';
            document.getElementById('ticketForm').reset();
            currentTicketId = null;
            
            const modal = new bootstrap.Modal(document.getElementById('ticketModal'));
            modal.show();
        }
        
        // Guardar ticket
        function saveTicket() {
            const form = document.getElementById('ticketForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const ticketData = {
                title: document.getElementById('ticketTitle').value,
                category: document.getElementById('ticketCategory').value,
                priority: document.getElementById('ticketPriority').value,
                probability: document.getElementById('ticketProbability').value,
                impact: document.getElementById('ticketImpact').value,
                description: document.getElementById('ticketDescription').value,
                assigned_to: document.getElementById('ticketAssignee').value,
                due_date: document.getElementById('ticketDueDate').value
            };
            
            if (currentTicketId) {
                // Editar ticket existente
                const ticketIndex = allTickets.findIndex(t => t.id === currentTicketId);
                if (ticketIndex !== -1) {
                    allTickets[ticketIndex] = { ...allTickets[ticketIndex], ...ticketData };
                    showNotification('Ticket actualizado exitosamente', 'success');
                }
            } else {
                // Crear nuevo ticket
                const newTicket = {
                    id: Date.now(),
                    number: `TK-${String(allTickets.length + 1).padStart(4, '0')}`,
                    status: 'ABIERTO',
                    created_at: new Date().toISOString(),
                    created_by: 'Usuario Actual',
                    ...ticketData
                };
                
                allTickets.unshift(newTicket);
                showNotification('Ticket creado exitosamente', 'success');
            }
            
            // Cerrar modal y recargar
            const modal = bootstrap.Modal.getInstance(document.getElementById('ticketModal'));
            modal.hide();
            
            loadTickets();
            updateStats();
        }
        
        // Mostrar detalles del ticket
        function showTicketDetails(ticketId) {
            const ticket = allTickets.find(t => t.id === ticketId);
            if (!ticket) return;
            
            document.getElementById('ticketDetailsTitle').textContent = `${ticket.number} - ${ticket.title}`;
            document.getElementById('ticketDetailsBody').innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <h6>Descripción</h6>
                        <p>${ticket.description}</p>
                        
                        <h6>Detalles</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <ul class="list-unstyled">
                                    <li><strong>Estado:</strong> <span class="status-badge status-${ticket.status}">${ticket.status.replace('_', ' ')}</span></li>
                                    <li><strong>Prioridad:</strong> <span class="priority-badge priority-${ticket.priority}">${ticket.priority}</span></li>
                                    <li><strong>Categoría:</strong> ${ticket.category}</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul class="list-unstyled">
                                    <li><strong>Creado por:</strong> ${ticket.created_by}</li>
                                    <li><strong>Asignado a:</strong> ${ticket.assigned_to || 'Sin asignar'}</li>
                                    <li><strong>Fecha límite:</strong> ${ticket.due_date ? new Date(ticket.due_date).toLocaleString() : 'Sin definir'}</li>
                                </ul>
                            </div>
                        </div>
                        
                        ${ticket.probability && ticket.impact ? `
                            <h6>Análisis de Riesgo</h6>
                            <ul class="list-unstyled">
                                <li><strong>Probabilidad:</strong> ${ticket.probability}/5</li>
                                <li><strong>Impacto:</strong> ${ticket.impact}/5</li>
                                <li><strong>Puntuación de Riesgo:</strong> ${ticket.probability * ticket.impact}/25</li>
                            </ul>
                        ` : ''}
                    </div>
                    <div class="col-md-4">
                        <h6>Historial de Actividad</h6>
                        <div class="activity-timeline">
                            <div class="activity-item">
                                <strong>Ticket creado</strong><br>
                                <small class="text-muted">${new Date(ticket.created_at).toLocaleString()}</small><br>
                                <em>Por ${ticket.created_by}</em>
                            </div>
                            ${ticket.assigned_to ? `
                                <div class="activity-item">
                                    <strong>Asignado</strong><br>
                                    <small class="text-muted">${new Date(ticket.created_at).toLocaleString()}</small><br>
                                    <em>A ${ticket.assigned_to}</em>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            currentTicketId = ticketId;
            const modal = new bootstrap.Modal(document.getElementById('ticketDetailsModal'));
            modal.show();
        }
        
        // Editar ticket
        function editTicket(ticketId) {
            const ticket = allTickets.find(t => t.id === ticketId);
            if (!ticket) return;
            
            // Llenar formulario con datos del ticket
            document.getElementById('ticketTitle').value = ticket.title;
            document.getElementById('ticketCategory').value = ticket.category;
            document.getElementById('ticketPriority').value = ticket.priority;
            document.getElementById('ticketProbability').value = ticket.probability || '';
            document.getElementById('ticketImpact').value = ticket.impact || '';
            document.getElementById('ticketDescription').value = ticket.description;
            document.getElementById('ticketAssignee').value = ticket.assigned_to || '';
            document.getElementById('ticketDueDate').value = ticket.due_date || '';
            
            document.getElementById('ticketModalTitle').textContent = 'Editar Ticket';
            currentTicketId = ticketId;
            
            const modal = new bootstrap.Modal(document.getElementById('ticketModal'));
            modal.show();
        }
        
        // Editar ticket actual desde detalles
        function editCurrentTicket() {
            if (currentTicketId) {
                const detailsModal = bootstrap.Modal.getInstance(document.getElementById('ticketDetailsModal'));
                detailsModal.hide();
                
                setTimeout(() => {
                    editTicket(currentTicketId);
                }, 300);
            }
        }
        
        // Agregar comentario
        function addComment(ticketId = null) {
            const id = ticketId || currentTicketId;
            showNotification('Función de comentarios en desarrollo', 'info');
        }
        
        // Mostrar notificaciones
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }
        
        // Event listeners adicionales
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyFilters();
            }
        });
        
        document.getElementById('sortBy').addEventListener('change', function(e) {
            currentSort.field = e.target.value;
            loadTickets();
        });
        
        // Funciones adicionales
        function showProfile() {
            showNotification('Perfil de usuario en desarrollo', 'info');
        }
        
        function logout() {
            if (confirm('¿Está seguro que desea cerrar sesión?')) {
                window.location.href = '/logout.php';
            }
        }
    </script>
</body>
</html>